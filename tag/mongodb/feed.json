{
    "version": "https://jsonfeed.org/version/1",
    "title": "Will • All posts by \"mongodb\" tag",
    "description": "愿你一生努力，一生被爱",
    "home_page_url": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io",
    "items": [
        {
            "id": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2024/01/03/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/Linux/Centos7/Centos7-MongoDB/",
            "url": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2024/01/03/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/Linux/Centos7/Centos7-MongoDB/",
            "title": "Centos7-MongoDB",
            "date_published": "2024-01-03T13:13:21.658Z",
            "content_html": "<h1 id=\"离线安装\"><a href=\"#离线安装\" class=\"headerlink\" title=\"离线安装\"></a>离线安装</h1><h2 id=\"下载安装包\"><a href=\"#下载安装包\" class=\"headerlink\" title=\"下载安装包\"></a>下载安装包</h2><p>根据自己的要求下载tar包，<a href=\"https://www.mongodb.com/try/download/community2\">点击此链接选择进行下载</a></p>\n<p>博猪下载版本为<code>mongodb-linux-x86_64-rhel70-4.4.17.tgz</code></p>\n<h2 id=\"上传安装包\"><a href=\"#上传安装包\" class=\"headerlink\" title=\"上传安装包\"></a>上传安装包</h2><h2 id=\"解压压缩包\"><a href=\"#解压压缩包\" class=\"headerlink\" title=\"解压压缩包\"></a>解压压缩包</h2><p>解压到 &#x2F;opt 目录下，并重命名</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">tar zxvf mongodb-linux-x86_64-rhel70-4.4.17.tgz -C /opt<br><br>mv mongodb-linux-x86_64-rhel70-6.0.0 mongodb<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置环境变量\"><a href=\"#配置环境变量\" class=\"headerlink\" title=\"配置环境变量\"></a>配置环境变量</h2><p>在 &#x2F;etc&#x2F;profile 中加入下面一行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">export PATH=/opt/mongodb/bin:$PATH<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">刷新配置</span><br>source /etc/profile<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"创建数据库目录和日志目录\"><a href=\"#创建数据库目录和日志目录\" class=\"headerlink\" title=\"创建数据库目录和日志目录\"></a>创建数据库目录和日志目录</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mkdir -p /opt/mongodb/logs  # 日志目录<br>mkdir -p /opt/mongodb/db  # 数据库目录<br><br>touch /opt/mongodb/logs/mongodb.log  # 创建日志文件<br>chmod 777 /opt/mongodb/logs<br>chmod 777 /opt/mongodb/db<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"创建配置文件\"><a href=\"#创建配置文件\" class=\"headerlink\" title=\"创建配置文件\"></a>创建配置文件</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">vi /opt/mongodb/mongodb.conf<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs properties\"><span class=\"hljs-attr\">port</span>= <span class=\"hljs-string\">27017</span><br><span class=\"hljs-attr\">dbpath</span>=<span class=\"hljs-string\">/opt/mongodb/db  # 指定数据库路径</span><br><span class=\"hljs-attr\">logpath</span>=<span class=\"hljs-string\">/opt/mongodb/logs/mongodb.log # 指定日志文件路径</span><br><span class=\"hljs-attr\">logappend</span>=<span class=\"hljs-string\">true  # 使用追加方式写日志</span><br><span class=\"hljs-attr\">fork</span>=<span class=\"hljs-string\">true  # 以守护进程的方式运行</span><br><span class=\"hljs-attr\">maxConns</span>=<span class=\"hljs-string\">100  # 最大同时连接数</span><br><span class=\"hljs-attr\">noauth</span>=<span class=\"hljs-string\">true  # 不启用验证</span><br><span class=\"hljs-attr\">journal</span>=<span class=\"hljs-string\">true  # 每次写入会记录一条操作日志</span><br><span class=\"hljs-attr\">storageEngine</span>=<span class=\"hljs-string\">wiredTiger # 存储引擎</span><br><span class=\"hljs-attr\">bind_ip</span>=<span class=\"hljs-string\">0.0.0.0 # 服务绑定地址</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"启动mongodb\"><a href=\"#启动mongodb\" class=\"headerlink\" title=\"启动mongodb\"></a>启动mongodb</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongod --config /opt/mongodb/mongodb.conf<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"启用授权验证\"><a href=\"#启用授权验证\" class=\"headerlink\" title=\"启用授权验证\"></a>启用授权验证</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongod --config /opt/mongodb/mongodb.conf --auth<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"停止-mongodb\"><a href=\"#停止-mongodb\" class=\"headerlink\" title=\"停止 mongodb\"></a>停止 mongodb</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongod --config /opt/mongodb/mongodb.conf --shutdown<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"配置开机启动\"><a href=\"#配置开机启动\" class=\"headerlink\" title=\"配置开机启动\"></a>配置开机启动</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">vim /etc/init.d/mongodb<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\"></span><br><span class=\"language-bash\"><span class=\"hljs-comment\">#chkconfig: 2345 80 90</span></span><br><span class=\"hljs-meta prompt_\">#</span><span class=\"language-bash\">description: mongodb</span><br>start() &#123;<br> /opt/mongodb/bin/mongod --config /opt/mongodb/mongodb.conf<br>&#125;<br> <br>stop() &#123;<br>  /opt/mongodb/bin/mongod --config /opt/mongodb/mongodb.conf --shutdown<br>&#125;<br> <br>case &quot;$1&quot; in<br>  start)<br> start<br> ;;<br>  stop)<br> stop<br> ;;<br>  restart)<br> stop<br> start<br> ;;<br>  *)<br> echo $&quot;Usage: $0 &#123;start|stop|restart&#125;&quot;<br> exit 1<br>esac<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">cd /etc/init.d/<br><br>sudo chkconfig --add mongodb<br>sudo chmod +x  mongodb<br>sudo chkconfig mongodb on<br></code></pre></td></tr></table></figure>\n\n<p>配置完成后可使用以下命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">启动mongodb：</span><br>service mongodb start<br><span class=\"hljs-meta prompt_\"></span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">停止mongodb：</span><br>service mongodb stop<br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：上述启动为root账户启动，权限太大，如果需要启用验证，则需要将配置文件（&#x2F;opt&#x2F;mongodb&#x2F;mongodb.conf）中的 noauth 设置为 false</p>\n</blockquote>\n<h1 id=\"Yum源安装\"><a href=\"#Yum源安装\" class=\"headerlink\" title=\"Yum源安装\"></a>Yum源安装</h1><h2 id=\"创建存储源文件夹\"><a href=\"#创建存储源文件夹\" class=\"headerlink\" title=\"创建存储源文件夹\"></a>创建存储源文件夹</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mkdir -p /opt/rpm_repo<br>cd /opt/rpm_repo\t<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"下载MongoDBYum源\"><a href=\"#下载MongoDBYum源\" class=\"headerlink\" title=\"下载MongoDBYum源\"></a>下载MongoDBYum源</h2><blockquote>\n<p>根据自己的要求下载tar包，<a href=\"https://www.mongodb.com/try/download/community2\">点击此链接选择进行下载</a>,选择一下三个选项，右键<code>Download</code>,复制链接地址即可。</p>\n<p><img src=\"http://tva1.sinaimg.cn/large/0086NgqGly1h7acvnupi8j313d0mp7ak.jpg\" alt=\"image.png\"></p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\"><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">shell-rpm</span><br>wget https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.4/x86_64/RPMS/mongodb-org-shell-4.4.17-1.el7.x86_64.rpm<br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">server-rpm</span><br>wget https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.4/x86_64/RPMS/mongodb-org-server-4.4.17-1.el7.x86_64.rpm<br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">mongos-rpm</span><br>wget https://repo.mongodb.org/yum/redhat/7/mongodb-org/4.4/x86_64/RPMS/mongodb-org-mongos-4.4.17-1.el7.x86_64.rpm<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"使用Yum安装\"><a href=\"#使用Yum安装\" class=\"headerlink\" title=\"使用Yum安装\"></a>使用Yum安装</h2><blockquote>\n<p>使用 yum 安装 mongodb，可以解决依赖包问题</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">yum install -y mongodb-org-*.rpm<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"查询MongoDB状态\"><a href=\"#查询MongoDB状态\" class=\"headerlink\" title=\"查询MongoDB状态\"></a>查询MongoDB状态</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">systemctl status mongod<br></code></pre></td></tr></table></figure>\n\n<p>如果启动，则需要停止运行，停止命令如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">systemctl stop mongod<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"修改MongoDB配置文件\"><a href=\"#修改MongoDB配置文件\" class=\"headerlink\" title=\"修改MongoDB配置文件\"></a>修改MongoDB配置文件</h2><ul>\n<li>备份配置文件</li>\n<li>备份配置文件</li>\n<li>备份配置文件</li>\n</ul>\n<p>重要的事情说三遍！！！！</p>\n<blockquote>\n<p>一般yum安装配置信息都在<code>/etc</code></p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">cd /etc<br>cp mongod.conf mongod.conf.bak<br></code></pre></td></tr></table></figure>\n\n<p>修改配置文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">vi mongod.conf<br></code></pre></td></tr></table></figure>\n\n<p>最终文件配置如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-comment\"># mongod.conf</span><br><br><span class=\"hljs-comment\"># for documentation of all options, see:</span><br><span class=\"hljs-comment\">#   http://docs.mongodb.org/manual/reference/configuration-options/</span><br><br><span class=\"hljs-comment\"># where to write logging data.</span><br><span class=\"hljs-attr\">systemLog:</span><br>  <span class=\"hljs-attr\">destination:</span> <span class=\"hljs-string\">file</span><br>  <span class=\"hljs-attr\">logAppend:</span> <span class=\"hljs-literal\">true</span><br>  <span class=\"hljs-comment\"># 指定日志文件路径</span><br>  <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/opt/mongodb/logs/mongod.log</span><br><br><span class=\"hljs-comment\"># Where and how to store data.</span><br><span class=\"hljs-attr\">storage:</span><br>  <span class=\"hljs-comment\"># 指定数据库路径</span><br>  <span class=\"hljs-attr\">dbPath:</span> <span class=\"hljs-string\">/opt/mongodb/db</span><br>  <span class=\"hljs-comment\"># 每次写入会记录一条操作日志</span><br>  <span class=\"hljs-attr\">journal:</span><br>    <span class=\"hljs-attr\">enabled:</span> <span class=\"hljs-literal\">true</span><br><span class=\"hljs-comment\">#  engine:</span><br><span class=\"hljs-comment\">#  wiredTiger:</span><br><br><span class=\"hljs-comment\"># how the process runs</span><br><span class=\"hljs-attr\">processManagement:</span><br>  <span class=\"hljs-comment\"># 以守护进程的方式运行</span><br>  <span class=\"hljs-attr\">fork:</span> <span class=\"hljs-literal\">true</span>  <span class=\"hljs-comment\"># fork and run in background</span><br>  <span class=\"hljs-attr\">pidFilePath:</span> <span class=\"hljs-string\">/var/run/mongodb/mongod.pid</span>  <span class=\"hljs-comment\"># location of pidfile</span><br>  <span class=\"hljs-attr\">timeZoneInfo:</span> <span class=\"hljs-string\">/usr/share/zoneinfo</span><br><br><span class=\"hljs-comment\"># network interfaces</span><br><span class=\"hljs-attr\">net:</span><br>  <span class=\"hljs-comment\"># 配置端口</span><br>  <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">37017</span><br>  <span class=\"hljs-comment\"># 服务绑定地址</span><br>  <span class=\"hljs-comment\"># 输入0.0.0.0，::绑定所有IPv4和IPv6地址，或者使用网络。bindIpAll设置</span><br>  <span class=\"hljs-attr\">bindIp:</span> <span class=\"hljs-number\">0.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.0</span>  <span class=\"hljs-comment\"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><br><br><br><span class=\"hljs-comment\">#security:</span><br><br><span class=\"hljs-comment\">#operationProfiling:</span><br><br><span class=\"hljs-comment\">#replication:</span><br><br><span class=\"hljs-comment\">#sharding:</span><br><br><span class=\"hljs-comment\">## Enterprise-Only Options</span><br><br><span class=\"hljs-comment\">#auditLog:</span><br><br><span class=\"hljs-comment\">#snmp:</span><br></code></pre></td></tr></table></figure>\n",
            "tags": [
                "Linux",
                "CentOS7",
                "MongoDB"
            ]
        },
        {
            "id": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2024/01/03/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/%E5%B7%A5%E5%85%B7%E7%B1%BB/%E5%9F%BA%E4%BA%8EMongoDB%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%A2%9EID/",
            "url": "https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2024/01/03/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/%E5%B7%A5%E5%85%B7%E7%B1%BB/%E5%9F%BA%E4%BA%8EMongoDB%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%A2%9EID/",
            "title": "基于MongoDB实现自增ID",
            "date_published": "2024-01-03T13:13:21.651Z",
            "content_html": "<blockquote>\n<p>因最近需要有个业务需要实现一个自增的流水号，其中细节值得学习，故记录下，以便反思总结。</p>\n<p>因为项目问题，故优先考虑在已存在的技术上进行实现，所以博猪优先想到的是：</p>\n<p>&#x3D;&#x3D;在MongoDB中，使用单独的集合来存放指定key对应的最大值，然后每次生成流水号时默认查询指定key对应的最大值，取出对应的主键的最大值+1，然后更新即可。博猪使用<code>AtomicInteger</code>来进行对应主键更新的原子性操作，但是在多线程测试时发现博猪对应MongoDB的数据操作有问题，造成了幻读现象，所以这个方案PASS掉了。&#x3D;&#x3D;</p>\n<p>最终方案博猪基于了Redis自增后实现的，下面直接上代码。</p>\n</blockquote>\n<h1 id=\"创建自增ID流水池\"><a href=\"#创建自增ID流水池\" class=\"headerlink\" title=\"创建自增ID流水池\"></a>创建自增ID流水池</h1><h2 id=\"定义集合\"><a href=\"#定义集合\" class=\"headerlink\" title=\"定义集合\"></a>定义集合</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-meta\">@Document(collection = &quot;MAKEUP_SERIAL_NUM_POOL&quot;)</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">MakeUpSerialNumPool</span> &#123;<br>    <span class=\"hljs-meta\">@Id</span><br>    <span class=\"hljs-meta\">@JsonIgnore</span><br>    <span class=\"hljs-keyword\">private</span> ObjectId _id;<br>    <span class=\"hljs-comment\">/** key值，业务组装，保持唯一 */</span><br>    <span class=\"hljs-keyword\">private</span> String key;<br>    <span class=\"hljs-comment\">/** 当前基数 */</span><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-type\">Integer</span> <span class=\"hljs-variable\">countNum</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"创建DAO\"><a href=\"#创建DAO\" class=\"headerlink\" title=\"创建DAO\"></a>创建DAO</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@ClassName</span> MakeUpSerialNumPoolRepository</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@Description</span>   自增ID记录池</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@Author</span> will</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@Date</span> @2022/2/9 15:48</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@Company</span> </span><br><span class=\"hljs-comment\"> */</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title class_\">MakeUpSerialNumPoolRepository</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_\">MongoRepository</span>&lt;MakeUpSerialNumPool, ObjectId&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"创建Service\"><a href=\"#创建Service\" class=\"headerlink\" title=\"创建Service\"></a>创建Service</h2><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">interface</span> <span class=\"hljs-title class_\">MakeUpSerialNumPoolService</span> &#123;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 保存或更新</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> key</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    Integer <span class=\"hljs-title function_\">getSerialNum</span><span class=\"hljs-params\">(String key)</span>;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 保存或更新</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> key</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    MakeUpSerialNumPool <span class=\"hljs-title function_\">findAndModify</span><span class=\"hljs-params\">(String key)</span>;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 删除</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> key</span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">findAndRemove</span><span class=\"hljs-params\">(String key)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Service</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">MakeUpSerialNumPoolServiceImpl</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title class_\">MakeUpSerialNumPoolService</span> &#123;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> MakeUpSerialNumPoolRepository makeUpSerialNumPoolRepository;<br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> MongoTemplate mongoTemplate;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-keyword\">public</span> Integer <span class=\"hljs-title function_\">getSerialNum</span><span class=\"hljs-params\">(String key)</span> &#123;<br>        <span class=\"hljs-type\">Query</span> <span class=\"hljs-variable\">query</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Query</span>(Criteria.where(<span class=\"hljs-string\">&quot;key&quot;</span>).is(key));<br>        <span class=\"hljs-type\">Update</span> <span class=\"hljs-variable\">update</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Update</span>();<br>        update.inc(<span class=\"hljs-string\">&quot;countNum&quot;</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-type\">FindAndModifyOptions</span> <span class=\"hljs-variable\">options</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">FindAndModifyOptions</span>();<br>        options.upsert(<span class=\"hljs-literal\">true</span>);<br>        options.returnNew(<span class=\"hljs-literal\">true</span>);<br>        <span class=\"hljs-type\">MakeUpSerialNumPool</span> <span class=\"hljs-variable\">pool</span> <span class=\"hljs-operator\">=</span> mongoTemplate.findAndModify(query, update, options, MakeUpSerialNumPool.class);<br>        <span class=\"hljs-keyword\">return</span> pool.getCountNum();<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-keyword\">public</span> MakeUpSerialNumPool <span class=\"hljs-title function_\">findAndModify</span><span class=\"hljs-params\">(String key)</span> &#123;<br>        <span class=\"hljs-type\">Query</span> <span class=\"hljs-variable\">query</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Query</span>(Criteria.where(<span class=\"hljs-string\">&quot;key&quot;</span>).is(key));<br>        <span class=\"hljs-type\">Update</span> <span class=\"hljs-variable\">update</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Update</span>();<br>        update.inc(<span class=\"hljs-string\">&quot;countNum&quot;</span>, <span class=\"hljs-number\">1</span>);<br>        <span class=\"hljs-type\">FindAndModifyOptions</span> <span class=\"hljs-variable\">options</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">FindAndModifyOptions</span>();<br>        options.upsert(<span class=\"hljs-literal\">true</span>);<br>        options.returnNew(<span class=\"hljs-literal\">true</span>);<br>        <span class=\"hljs-type\">MakeUpSerialNumPool</span> <span class=\"hljs-variable\">pool</span> <span class=\"hljs-operator\">=</span> mongoTemplate.findAndModify(query, update, options, MakeUpSerialNumPool.class);<br>        <span class=\"hljs-keyword\">return</span> pool;<br>    &#125;<br><br>    <span class=\"hljs-meta\">@Override</span><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">findAndRemove</span><span class=\"hljs-params\">(String key)</span> &#123;<br>        <span class=\"hljs-type\">Query</span> <span class=\"hljs-variable\">query</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Query</span>(Criteria.where(<span class=\"hljs-string\">&quot;key&quot;</span>).is(key));<br>        mongoTemplate.findAndRemove(query, MakeUpSerialNumPool.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"封装ID自增工具类\"><a href=\"#封装ID自增工具类\" class=\"headerlink\" title=\"封装ID自增工具类\"></a>封装ID自增工具类</h1><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\"> * 自增主键类型</span><br><span class=\"hljs-comment\"> *  业务主键前缀（含表达式）+length为自增</span><br><span class=\"hljs-comment\"> */</span><br><span class=\"hljs-meta\">@Data</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">AutoIncSeqType</span> &#123;<br>    <span class=\"hljs-comment\">/* 前缀表达式 */</span><br>    <span class=\"hljs-keyword\">private</span> String keyPrefix;<br>    <span class=\"hljs-comment\">/* 序列长度 */</span><br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-type\">int</span> length;<br>    <span class=\"hljs-comment\">/* 日期格式化 */</span><br>    <span class=\"hljs-keyword\">private</span> String format;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-title function_\">AutoIncSeqType</span><span class=\"hljs-params\">(String keyPrefix, <span class=\"hljs-type\">int</span> length, String format)</span> &#123;<br>        <span class=\"hljs-built_in\">this</span>.keyPrefix = keyPrefix;<br>        <span class=\"hljs-built_in\">this</span>.length = length;<br>        <span class=\"hljs-built_in\">this</span>.format = format;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Component</span><br><span class=\"hljs-meta\">@Slf4j</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">KeyGenerator</span> &#123;<br><br>    <span class=\"hljs-comment\">/*【&quot;SN:&quot;, &quot;FBDZ&#123;yyyyMM&#125;&quot;, 4, &quot;yyyyMM&quot;, RedisExpireTypeEnum.NON】*/</span><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">YYMM</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;yyMM&quot;</span>;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">YYYYMM</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;yyyyMM&quot;</span>;<br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">YYYYMMDD</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;yyyyMMdd&quot;</span>;<br><br>    <span class=\"hljs-meta\">@Autowired</span><br>    <span class=\"hljs-keyword\">private</span> MakeUpSerialNumPoolService makeUpSerialNumPoolService;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> incrSeqType</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title function_\">getIncrSeq</span><span class=\"hljs-params\">(AutoIncSeqType incrSeqType)</span> &#123;<br>        <span class=\"hljs-keyword\">return</span> getIncrSeq(<span class=\"hljs-string\">&quot;&quot;</span>, incrSeqType, <span class=\"hljs-string\">&quot;&quot;</span>);<br>    &#125;<br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     *</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> incrSeqType</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> orgCode</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title function_\">getIncrSeq</span><span class=\"hljs-params\">(AutoIncSeqType incrSeqType, String orgCode)</span> &#123;<br>        <span class=\"hljs-keyword\">return</span> getIncrSeq(<span class=\"hljs-string\">&quot;&quot;</span>, incrSeqType, orgCode);<br>    &#125;<br><br>    <span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\">     * 生成日期 自增序号</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> prefix 前缀，为空则不加</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> incrSeqType 业务配置</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@param</span> orgCode 经销商、机构等代码</span><br><span class=\"hljs-comment\">     * <span class=\"hljs-doctag\">@return</span></span><br><span class=\"hljs-comment\">     */</span><br>    <span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title function_\">getIncrSeq</span><span class=\"hljs-params\">(String prefix, AutoIncSeqType incrSeqType, String orgCode)</span> &#123;<br>        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">dateInfo</span> <span class=\"hljs-operator\">=</span> DateUtils.formatDate(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>(), incrSeqType.getFormat());<br>        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">key</span> <span class=\"hljs-operator\">=</span> incrSeqType.getKeyPrefix().replaceAll(<span class=\"hljs-string\">&quot;\\\\&#123;&quot;</span> + incrSeqType.getFormat() + <span class=\"hljs-string\">&quot;\\\\&#125;&quot;</span>, dateInfo);<br>        key = key.replaceAll(<span class=\"hljs-string\">&quot;\\\\&#123;orgCode\\\\&#125;&quot;</span>, orgCode);<br>        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">keyInfo</span> <span class=\"hljs-operator\">=</span> StringUtils.isNotEmpty(prefix) ? prefix + key : key;<br><br>        <span class=\"hljs-keyword\">try</span> &#123;<br>            <span class=\"hljs-type\">Integer</span> <span class=\"hljs-variable\">incr</span> <span class=\"hljs-operator\">=</span> getIncr(keyInfo);<br>            <span class=\"hljs-keyword\">if</span>(incr == <span class=\"hljs-number\">0</span>) &#123;<br>                incr = getIncr(keyInfo);<span class=\"hljs-comment\">//从001开始</span><br>            &#125;<br>            <span class=\"hljs-keyword\">return</span> keyInfo.replace(<span class=\"hljs-string\">&quot;:&quot;</span>,<span class=\"hljs-string\">&quot;&quot;</span>) + String.format(<span class=\"hljs-string\">&quot;%0&quot;</span> + incrSeqType.getLength() +<span class=\"hljs-string\">&quot;d&quot;</span>, incr);<br>        &#125; <span class=\"hljs-keyword\">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            log.error(<span class=\"hljs-string\">&quot;MongoDB生成自增异常：&quot;</span>, e);<br><br>            <span class=\"hljs-comment\">/* 异常时自动生成随机序列号，E结尾*/</span><br>            <span class=\"hljs-keyword\">return</span> keyInfo + RandomUtils.getRandomNumbers(incrSeqType.getLength()) + <span class=\"hljs-string\">&quot;E&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> Integer <span class=\"hljs-title function_\">getIncr</span><span class=\"hljs-params\">(String key)</span> &#123;<br>        <span class=\"hljs-type\">MakeUpSerialNumPool</span> <span class=\"hljs-variable\">makeUpSerialNumPool</span> <span class=\"hljs-operator\">=</span> makeUpSerialNumPoolService.findAndModify(key);<br>        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">month</span> <span class=\"hljs-operator\">=</span> key.split(<span class=\"hljs-string\">&quot;:&quot;</span>)[<span class=\"hljs-number\">1</span>];<br>        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">currentMonth</span> <span class=\"hljs-operator\">=</span> String.valueOf(DateUtil.format(<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>(), YYYYMM));<br>        <span class=\"hljs-keyword\">if</span> (makeUpSerialNumPool == <span class=\"hljs-literal\">null</span> || !month.equals(currentMonth)) &#123;<br>            makeUpSerialNumPoolService.findAndRemove(key);<br>        &#125;<br>        <span class=\"hljs-keyword\">return</span> makeUpSerialNumPool.getCountNum();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">RandomUtils</span> &#123;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-type\">char</span>[] codeSequence = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">char</span>[]&#123;<span class=\"hljs-string\">&#x27;A&#x27;</span>, <span class=\"hljs-string\">&#x27;B&#x27;</span>, <span class=\"hljs-string\">&#x27;C&#x27;</span>, <span class=\"hljs-string\">&#x27;D&#x27;</span>, <span class=\"hljs-string\">&#x27;E&#x27;</span>, <span class=\"hljs-string\">&#x27;F&#x27;</span>, <span class=\"hljs-string\">&#x27;G&#x27;</span>, <span class=\"hljs-string\">&#x27;H&#x27;</span>, <span class=\"hljs-string\">&#x27;I&#x27;</span>, <span class=\"hljs-string\">&#x27;J&#x27;</span>, <span class=\"hljs-string\">&#x27;K&#x27;</span>, <span class=\"hljs-string\">&#x27;L&#x27;</span>, <span class=\"hljs-string\">&#x27;M&#x27;</span>, <span class=\"hljs-string\">&#x27;N&#x27;</span>, <span class=\"hljs-string\">&#x27;O&#x27;</span>, <span class=\"hljs-string\">&#x27;P&#x27;</span>, <span class=\"hljs-string\">&#x27;Q&#x27;</span>, <span class=\"hljs-string\">&#x27;R&#x27;</span>, <span class=\"hljs-string\">&#x27;S&#x27;</span>, <span class=\"hljs-string\">&#x27;T&#x27;</span>, <span class=\"hljs-string\">&#x27;U&#x27;</span>, <span class=\"hljs-string\">&#x27;V&#x27;</span>, <span class=\"hljs-string\">&#x27;W&#x27;</span>, <span class=\"hljs-string\">&#x27;X&#x27;</span>, <span class=\"hljs-string\">&#x27;Y&#x27;</span>, <span class=\"hljs-string\">&#x27;Z&#x27;</span>, <span class=\"hljs-string\">&#x27;a&#x27;</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>, <span class=\"hljs-string\">&#x27;c&#x27;</span>, <span class=\"hljs-string\">&#x27;d&#x27;</span>, <span class=\"hljs-string\">&#x27;e&#x27;</span>, <span class=\"hljs-string\">&#x27;f&#x27;</span>, <span class=\"hljs-string\">&#x27;g&#x27;</span>, <span class=\"hljs-string\">&#x27;h&#x27;</span>, <span class=\"hljs-string\">&#x27;i&#x27;</span>, <span class=\"hljs-string\">&#x27;j&#x27;</span>, <span class=\"hljs-string\">&#x27;k&#x27;</span>, <span class=\"hljs-string\">&#x27;l&#x27;</span>, <span class=\"hljs-string\">&#x27;m&#x27;</span>, <span class=\"hljs-string\">&#x27;n&#x27;</span>, <span class=\"hljs-string\">&#x27;o&#x27;</span>, <span class=\"hljs-string\">&#x27;p&#x27;</span>, <span class=\"hljs-string\">&#x27;q&#x27;</span>, <span class=\"hljs-string\">&#x27;r&#x27;</span>, <span class=\"hljs-string\">&#x27;s&#x27;</span>, <span class=\"hljs-string\">&#x27;t&#x27;</span>, <span class=\"hljs-string\">&#x27;u&#x27;</span>, <span class=\"hljs-string\">&#x27;v&#x27;</span>, <span class=\"hljs-string\">&#x27;w&#x27;</span>, <span class=\"hljs-string\">&#x27;x&#x27;</span>, <span class=\"hljs-string\">&#x27;y&#x27;</span>, <span class=\"hljs-string\">&#x27;z&#x27;</span>, <span class=\"hljs-string\">&#x27;0&#x27;</span>, <span class=\"hljs-string\">&#x27;1&#x27;</span>, <span class=\"hljs-string\">&#x27;2&#x27;</span>, <span class=\"hljs-string\">&#x27;3&#x27;</span>, <span class=\"hljs-string\">&#x27;4&#x27;</span>, <span class=\"hljs-string\">&#x27;5&#x27;</span>, <span class=\"hljs-string\">&#x27;6&#x27;</span>, <span class=\"hljs-string\">&#x27;7&#x27;</span>, <span class=\"hljs-string\">&#x27;8&#x27;</span>, <span class=\"hljs-string\">&#x27;9&#x27;</span>&#125;;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-type\">char</span>[] numSequence = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">char</span>[]&#123;<span class=\"hljs-string\">&#x27;0&#x27;</span>, <span class=\"hljs-string\">&#x27;1&#x27;</span>, <span class=\"hljs-string\">&#x27;2&#x27;</span>, <span class=\"hljs-string\">&#x27;3&#x27;</span>, <span class=\"hljs-string\">&#x27;4&#x27;</span>, <span class=\"hljs-string\">&#x27;5&#x27;</span>, <span class=\"hljs-string\">&#x27;6&#x27;</span>, <span class=\"hljs-string\">&#x27;7&#x27;</span>, <span class=\"hljs-string\">&#x27;8&#x27;</span>, <span class=\"hljs-string\">&#x27;9&#x27;</span>&#125;;<br>    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-type\">SecureRandom</span> <span class=\"hljs-variable\">random</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">SecureRandom</span>();<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-title function_\">RandomUtils</span><span class=\"hljs-params\">()</span> &#123;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> String <span class=\"hljs-title function_\">getRandomChars</span><span class=\"hljs-params\">()</span> &#123;<br>        <span class=\"hljs-type\">Random</span> <span class=\"hljs-variable\">random</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Random</span>();<br>        <span class=\"hljs-type\">StringBuffer</span> <span class=\"hljs-variable\">sBuffer</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">StringBuffer</span>();<br><br>        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-type\">int</span> <span class=\"hljs-variable\">i</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">14</span>; ++i) &#123;<br>            sBuffer.append(codeSequence[random.nextInt(<span class=\"hljs-number\">62</span>)]);<br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> sBuffer.toString();<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> String <span class=\"hljs-title function_\">getRandomChars</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> length)</span> &#123;<br>        <span class=\"hljs-type\">Random</span> <span class=\"hljs-variable\">random</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Random</span>();<br>        <span class=\"hljs-type\">StringBuffer</span> <span class=\"hljs-variable\">sBuffer</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">StringBuffer</span>();<br>        <span class=\"hljs-keyword\">if</span> (length &lt; <span class=\"hljs-number\">1</span>) &#123;<br>            length = <span class=\"hljs-number\">14</span>;<br>        &#125;<br><br>        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-type\">int</span> <span class=\"hljs-variable\">i</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>; i &lt; length; ++i) &#123;<br>            sBuffer.append(codeSequence[random.nextInt(<span class=\"hljs-number\">62</span>)]);<br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> sBuffer.toString();<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> String <span class=\"hljs-title function_\">getRandomNumbers</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> length)</span> &#123;<br>        <span class=\"hljs-type\">Random</span> <span class=\"hljs-variable\">random</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Random</span>();<br>        <span class=\"hljs-type\">StringBuffer</span> <span class=\"hljs-variable\">sBuffer</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">StringBuffer</span>();<br>        <span class=\"hljs-keyword\">if</span> (length &lt; <span class=\"hljs-number\">1</span>) &#123;<br>            length = <span class=\"hljs-number\">14</span>;<br>        &#125;<br><br>        <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-type\">int</span> <span class=\"hljs-variable\">i</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">0</span>; i &lt; length; ++i) &#123;<br>            sBuffer.append(numSequence[random.nextInt(<span class=\"hljs-number\">10</span>)]);<br>        &#125;<br><br>        <span class=\"hljs-keyword\">return</span> sBuffer.toString();<br>    &#125;<br><br>    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> String <span class=\"hljs-title function_\">generateRandomString</span><span class=\"hljs-params\">(<span class=\"hljs-type\">int</span> numBytes)</span> &#123;<br>        <span class=\"hljs-keyword\">if</span> (numBytes &lt; <span class=\"hljs-number\">1</span>) &#123;<br>            <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">IllegalArgumentException</span>(String.format(<span class=\"hljs-string\">&quot;numBytes argument must be a positive integer (1 or larger)&quot;</span>, (<span class=\"hljs-type\">long</span>)numBytes));<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-type\">byte</span>[] bytes = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">byte</span>[numBytes];<br>            random.nextBytes(bytes);<br>            <span class=\"hljs-keyword\">return</span> Hex.encodeHexString(bytes);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"使用Demo\"><a href=\"#使用Demo\" class=\"headerlink\" title=\"使用Demo\"></a>使用Demo</h1><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Java\"><span class=\"hljs-meta\">@Autowired</span><br><span class=\"hljs-keyword\">private</span> KeyGenerator keyGenerator;<br></code></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">key</span> <span class=\"hljs-operator\">=</span> agentCode + <span class=\"hljs-string\">&quot;:&quot;</span> + currentMonth;<br><span class=\"hljs-type\">AutoIncSeqType</span> <span class=\"hljs-variable\">autoIncSeqType</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">AutoIncSeqType</span>(key, <span class=\"hljs-number\">4</span>, dateFormat);<br><span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">incrSeq</span> <span class=\"hljs-operator\">=</span> keyGenerator.getIncrSeq(<span class=\"hljs-literal\">null</span>, autoIncSeqType, agentCode);<br></code></pre></td></tr></table></figure>\n\n<h1 id=\"心得\"><a href=\"#心得\" class=\"headerlink\" title=\"心得\"></a>心得</h1><blockquote>\n<p>上述方法博猪本地测试了一下单次循环，5k的线程没有问题，由于博猪电脑配置较低就没有再进行深入的测试，反正使用是没有太大的问题。</p>\n<p>下面说一下博猪的心得：</p>\n<ul>\n<li><p>上面的方法其实和博猪第一的思考方式是一样的，但是博猪之前考虑的是从Java层面解决并发导致的事务问题，所以没有仔细的研究MongoDB</p>\n</li>\n<li><p>mongodb不支持事务，所以，在你的项目中应用时，要注意这点。无论什么设计，都不要要求mongodb保证数据的完整性。但是mongodb提供了许多原子操作，比如文档的保存，修改，删除等，都是原子操作。</p>\n<p>所谓原子操作就是要么这个文档保存到Mongodb，要么没有保存到Mongodb，不会出现查询到的文档没有保存完整的情况。</p>\n</li>\n</ul>\n</blockquote>\n",
            "tags": [
                "JAVA",
                "MongoDb"
            ]
        }
    ]
}