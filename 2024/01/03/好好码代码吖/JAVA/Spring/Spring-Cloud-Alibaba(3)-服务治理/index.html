<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="will"><meta name="keywords" content="will"><meta name="description" content="服务治理介绍先来思考一个问题通过上一章的操作，我们已经可以实现微服务之间的调用。但是我们把服务提供者的网络地址（ip，端口）等硬编码到了代码中，这种做法存在许多问题：  一旦服务提供者地址变化，就需要手工修改代码 一旦是多个服务提供者，无法实现负载均衡功能 一旦服务变得越来越多，人工维护调用关系困难  那么应该怎么解决呢， 这时候就需要通过注册中心动态的实现服务治理。 什么是服务治理服务治理是微服"><meta property="og:type" content="article"><meta property="og:title" content="Spring-Cloud-Alibaba(3)-服务治理"><meta property="og:url" content="https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2024/01/03/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/Spring-Cloud-Alibaba(3)-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86/index.html"><meta property="og:site_name" content="Will"><meta property="og:description" content="服务治理介绍先来思考一个问题通过上一章的操作，我们已经可以实现微服务之间的调用。但是我们把服务提供者的网络地址（ip，端口）等硬编码到了代码中，这种做法存在许多问题：  一旦服务提供者地址变化，就需要手工修改代码 一旦是多个服务提供者，无法实现负载均衡功能 一旦服务变得越来越多，人工维护调用关系困难  那么应该怎么解决呢， 这时候就需要通过注册中心动态的实现服务治理。 什么是服务治理服务治理是微服"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://z3.ax1x.com/2021/07/03/RRd8Ag.jpg"><meta property="og:image" content="https://z3.ax1x.com/2021/07/05/R5qdHA.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/05/R5LFDH.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/05/R5xV91.png"><meta property="og:image" content="https://z3.ax1x.com/2021/07/11/W9yfHO.png"><meta property="article:published_time" content="2024-01-03T13:13:21.646Z"><meta property="article:modified_time" content="2024-01-03T13:13:21.646Z"><meta property="article:author" content="will"><meta property="article:tag" content="JAVA"><meta property="article:tag" content="Spring"><meta property="article:tag" content="SpringCloud"><meta property="article:tag" content="SpringCloud Alibaba"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://z3.ax1x.com/2021/07/03/RRd8Ag.jpg"><title>Spring-Cloud-Alibaba(3)-服务治理 - Will</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var dntVal,Fluid=window.Fluid||{},CONFIG=(Fluid.ctx=Object.assign({},Fluid.ctx),{hostname:"github.com",root:"/",version:"1.9.4",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"});CONFIG.web_analytics.follow_dnt&&(dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on")))</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>WILL</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="Spring-Cloud-Alibaba(3)-服务治理"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-01-03 21:13" pubdate>2024年1月3日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 12k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 104 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">Spring-Cloud-Alibaba(3)-服务治理</h1><div class="markdown-body"><h1 id="服务治理介绍"><a href="#服务治理介绍" class="headerlink" title="服务治理介绍"></a>服务治理介绍</h1><p>先来思考一个问题<br>通过上一章的操作，我们已经可以实现微服务之间的调用。但是我们把服务提供者的网络地址（ip，端口）等硬编码到了代码中，这种做法存在许多问题：</p><ul><li>一旦服务提供者地址变化，就需要手工修改代码</li><li>一旦是多个服务提供者，无法实现负载均衡功能</li><li>一旦服务变得越来越多，人工维护调用关系困难</li></ul><p><strong>那么应该怎么解决呢， 这时候就需要通过注册中心动态的实现服务治理。</strong></p><h2 id="什么是服务治理"><a href="#什么是服务治理" class="headerlink" title="什么是服务治理"></a>什么是服务治理</h2><p>服务治理是微服务架构中最核心最基本的模块。用于实现各个微服务的自动化注册与发现。</p><ul><li>服务注册：在服务治理框架中，都会构建一个注册中心，每个服务单元向注册中心登记自己提供服务的详细信息。并在注册中心形成一张服务的清单，服务注册中心需要以心跳的方式去监测清单中的服务是否可用，如果不可用，需要在服务清单中剔除不可用的服务。</li><li>服务发现：服务调用方向服务注册中心咨询服务，并获取所有服务的实例清单，实现对具体服务实<br>例的访问。</li></ul><p><img src="https://z3.ax1x.com/2021/07/03/RRd8Ag.jpg" srcset="/img/loading.gif" lazyload alt="RRd8Ag.jpg"><a target="_blank" rel="noopener" href="https://imgtu.com/i/RRd8Ag">https://imgtu.com/i/RRd8Ag</a></p><p>通过上面的调用图会发现，除了微服务，还有一个组件是服务注册中心，它是微服务架构非常重要的一个组件，在微服务架构里主要起到了协调者的一个作用。注册中心一般包含如下几个功能：</p><ul><li><p>服务发现：</p><ul><li>服务注册：保存服务提供者和服务调用者的信息</li><li>服务订阅：服务调用者订阅服务提供者的信息，注册中心向订阅者推送提供者的信息</li></ul></li><li><p>服务配置：</p><ul><li>配置订阅：服务提供者和服务调用者订阅微服务相关的配置</li><li>配置下发：主动将配置推送给服务提供者和服务调用者</li></ul></li><li><p>服务健康检测</p><ul><li>检测服务提供者的健康情况，如果发现异常，执行服务剔除</li></ul></li></ul><h2 id="常见的注册中心"><a href="#常见的注册中心" class="headerlink" title="常见的注册中心"></a>常见的注册中心</h2><ul><li><p>Zookeeper<br>zookeeper是一个分布式服务框架，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。</p></li><li><p>Eureka<br>Eureka是Springcloud Netflix中的重要组件，主要作用就是做服务注册和发现。但是现在已经闭源</p></li><li><p>Consul</p><p>Consul是基于GO语言开发的开源工具，主要面向分布式，服务化的系统提供服务注册、服务发现和配置管理的功能。Consul的功能都很实用，其中包括：服务注册&#x2F;发现、健康检查、Key&#x2F;Value存储、多数据中心和分布式一致性保证等特性。Consul本身只是一个二进制的可执行文件，所以安装和部署都非常简单，只需要从官网下载后，在执行对应的启动脚本即可。</p></li><li><p>Nacos</p><p>Nacos是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。它是 SpringCloud Alibaba 组件之一，负责服务注册发现和服务配置，可以这样认为nacos&#x3D;eureka+config。</p></li></ul><h2 id="nacos简介"><a href="#nacos简介" class="headerlink" title="nacos简介"></a>nacos简介</h2><p>Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。从上面的介绍就可以看出，nacos的作用就是一个注册中心，用来管理注册上来的各个微服务。</p><h2 id="nacos实战入门"><a href="#nacos实战入门" class="headerlink" title="nacos实战入门"></a>nacos实战入门</h2><blockquote><p>本篇只讲解windows安装运行，Linux安装部署请参考博猪Docker系列中的docker安装部署Nacos.</p></blockquote><p>接下来，我们就在现有的环境中加入nacos，并将我们的两个微服务注册上去。</p><h3 id="搭建nacos环境"><a href="#搭建nacos环境" class="headerlink" title="搭建nacos环境"></a>搭建nacos环境</h3><ul><li>安装nacos</li></ul><blockquote><p>下载地址: <a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a><br>下载zip格式的安装包，然后进行解压缩操作</p></blockquote><ul><li>启动nacos</li></ul><blockquote><p>切换目录</p><p>cd nacos&#x2F;bin</p><p>命令启动</p><p>startup.cmd -m standalone</p></blockquote><ul><li>访问nacos</li></ul><blockquote><p>打开浏览器输入<a target="_blank" rel="noopener" href="http://localhost:8848/nacos%EF%BC%8C%E5%8D%B3%E5%8F%AF%E8%AE%BF%E9%97%AE%E6%9C%8D%E5%8A%A1%EF%BC%8C">http://localhost:8848/nacos，即可访问服务，</a> 默认密码是nacos&#x2F;nacos</p></blockquote><h3 id="注册微服务"><a href="#注册微服务" class="headerlink" title="注册微服务"></a>注册微服务</h3><ul><li>在pom.xml中添加nacos的依赖</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacos客户端--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>开启服务发现注解，在项目引导类<code>ProductApplication</code>上增加<code>@EnableDiscoveryClient</code>注解</li><li>添加注册中心配置</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">cloud:</span><br>  <span class="hljs-attr">nacos:</span><br>    <span class="hljs-attr">discovery:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.120</span><span class="hljs-string">:8848</span> <span class="hljs-comment"># 注册中心nacos服务端地址及端口</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">6d39b87a-55bb-4497-bec5-79bdd3b9789b</span> <span class="hljs-comment"># 命名空间，方便管理</span><br></code></pre></td></tr></table></figure><ul><li>启动服务， 观察nacos的控制面板中是否有注册上来的微服务</li></ul><h2 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h2><ul><li>修改订单Controller</li><li>增加<code>服务发现</code>api和常量:</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NACOS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;nacos&quot;</span>;<br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;<br></code></pre></td></tr></table></figure><ul><li>增加私有方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通过服务发现接口</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pId    产品id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">queryProductByDiscoveryClient</span><span class="hljs-params">(Integer pId)</span> &#123;<br>    List&lt;ServiceInstance&gt; productInstances = discoveryClient.getInstances(<span class="hljs-string">&quot;shop-product&quot;</span>);<br>    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(productInstances)) &#123;<br>        log.error(<span class="hljs-string">&quot;产品服务为空！&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">defaultServiceInstance</span> <span class="hljs-operator">=</span> productInstances.get(<span class="hljs-number">0</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> defaultServiceInstance.getHost();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> defaultServiceInstance.getPort();<br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(<span class="hljs-string">&quot;http://&quot;</span> + host + <span class="hljs-string">&quot;:&quot;</span> + port + <span class="hljs-string">&quot;/product/info/&quot;</span> + pId, Product.class);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>修改保存订单方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 保存指定产品订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/save/&#123;pId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pId&quot;)</span> Integer pId, <span class="hljs-meta">@RequestParam(name = &quot;queryType&quot;)</span> String queryType)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;&gt;&gt;客户下单，这时候要调用商品微服务查询商品信息&quot;</span>);<br>    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// 通过restTemplate调用商品微服务</span><br>    <span class="hljs-keyword">if</span> (REST_TEMPLATE.equals(queryType)) &#123;<br>        product = queryProductByRestTemplate(pId);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (NACOS.equals(queryType)) &#123;<br>        product = queryProductByDiscoveryClient(pId);<br>    &#125;<br><br>    log.info(<span class="hljs-string">&quot;&gt;&gt;商品信息,查询结果:&quot;</span> + JSON.toJSONString(product));<br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>    order.setUId(<span class="hljs-number">1</span>);<br>    order.setUserName(<span class="hljs-string">&quot;测试用户&quot;</span>);<br>    order.setPId(product.getPId());<br>    order.setPName(product.getPName());<br>    order.setPPrice(product.getPPrice());<br>    order.setNumber(<span class="hljs-number">1</span>);<br>    orderService.saveOrder(order);<br>    <span class="hljs-keyword">return</span> order;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>DiscoveryClient是专门负责服务注册和发现的，我们可以通过它获取到注册到注册中心的所有服务。</p></blockquote><ul><li>启动测试</li></ul><p>启动服务， 观察nacos的控制面板中是否有注册上来的订单微服务，然后通过访问消费者服务验证调用是否成功</p><p><img src="https://z3.ax1x.com/2021/07/05/R5qdHA.png" srcset="/img/loading.gif" lazyload alt="R5qdHA.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/R5qdHA">https://imgtu.com/i/R5qdHA</a></p><h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><h2 id="什么是负载均衡"><a href="#什么是负载均衡" class="headerlink" title="什么是负载均衡"></a>什么是负载均衡</h2><blockquote><p>通俗的讲， 负载均衡就是将负载（工作任务，访问请求）进行分摊到多个操作单元（服务器,组件）上进行执行。<br>根据负载均衡发生位置的不同,一般分为服务端负载均衡和客户端负载均衡。<br>服务端负载均衡指的是发生在服务提供者一方,比如常见的<code>Nginx</code>负载均衡<br>而客户端负载均衡指的是发生在服务请求的一方，也就是在发送请求之前已经选好了由哪个实例处理请求。</p></blockquote><p><img src="https://z3.ax1x.com/2021/07/05/R5LFDH.png" srcset="/img/loading.gif" lazyload alt="R5LFDH.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/R5LFDH">https://imgtu.com/i/R5LFDH</a></p><p>我们在微服务调用关系中一般会选择客户端负载均衡，也就是在服务调用的一方来决定服务由哪个提供者执行。</p><h2 id="自定义实现负载均衡"><a href="#自定义实现负载均衡" class="headerlink" title="自定义实现负载均衡"></a>自定义实现负载均衡</h2><ul><li>通过idea再启动一个 shop-product 微服务，设置其端口为8082</li><li>通过nacos查看微服务的启动情况</li></ul><p><img src="https://z3.ax1x.com/2021/07/05/R5xV91.png" srcset="/img/loading.gif" lazyload alt="R5xV91.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/R5xV91">https://imgtu.com/i/R5xV91</a></p><ul><li>修改 <code>shop-order</code> 的代码，实现负载均衡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 通过服务发现接口</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> pId   产品id</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">private</span> Product <span class="hljs-title function_">queryProductByDiscoveryClient</span><span class="hljs-params">(Integer pId)</span> &#123;<br>       List&lt;ServiceInstance&gt; productInstances = discoveryClient.getInstances(<span class="hljs-string">&quot;shop-product&quot;</span>);<br>       <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(productInstances)) &#123;<br>           log.error(<span class="hljs-string">&quot;产品服务为空！&quot;</span>);<br>       &#125;<br>       <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(productInstances.size());<br>       <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">defaultServiceInstance</span> <span class="hljs-operator">=</span> productInstances.get(index);<br>       <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> defaultServiceInstance.getHost();<br>       <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> defaultServiceInstance.getPort();<br>       <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://&quot;</span> + host + <span class="hljs-string">&quot;:&quot;</span> + port + <span class="hljs-string">&quot;/product/info/&quot;</span> + pId;<br>       log.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;从nacos中获取到的微服务地址为:&quot;</span> + url);<br><br>       <span class="hljs-keyword">return</span> restTemplate.getForObject(url, Product.class);<br>   &#125;<br></code></pre></td></tr></table></figure><ul><li>启动两个服务提供者和一个服务消费者，多访问几次消费者测试效果</li></ul><p><img src="https://z3.ax1x.com/2021/07/11/W9yfHO.png" srcset="/img/loading.gif" lazyload alt="W9yfHO.png"><a target="_blank" rel="noopener" href="https://imgtu.com/i/W9yfHO">https://imgtu.com/i/W9yfHO</a></p><blockquote><p>从上述图片我们可以看出我们自定义的负载均衡存在一下几点情况：</p><ul><li>对业务代码侵入性太高；</li><li>请求具有不确定性；</li><li>请求分发策略单一，更改难度较大</li></ul><p>对于以上问题，SpringCloud 已经为我们提供了一个解决方案：<code>Ribbon</code></p></blockquote><h2 id="基于Ribbon实现负载均衡"><a href="#基于Ribbon实现负载均衡" class="headerlink" title="基于Ribbon实现负载均衡"></a>基于Ribbon实现负载均衡</h2><blockquote><p>Ribbon是Spring Cloud的一个组件， 它可以让我们使用一个注解就能轻松的搞定负载均衡</p></blockquote><ul><li>在RestTemplate 的生成方法上添加@LoadBalanced注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@LoadBalanced</span><br><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>增加负载均衡调用算法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * RestTemplate   负载均衡风格查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pId    产品id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Product <span class="hljs-title function_">queryProductLoadBalancingByRibbon</span><span class="hljs-params">(Integer pId)</span> &#123;<br>    <span class="hljs-keyword">return</span> restTemplate.getForObject(<span class="hljs-string">&quot;http://shop-product/product/info/&quot;</span> + pId, Product.class);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>修改下单方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RIBBON</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ribbon&quot;</span>;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 保存指定产品订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/save/&#123;pId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pId&quot;)</span> Integer pId, <span class="hljs-meta">@RequestParam(name = &quot;queryType&quot;)</span> String queryType)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;&gt;&gt;客户下单，这时候要调用商品微服务查询商品信息&quot;</span>);<br>    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// 通过restTemplate调用商品微服务</span><br>    <span class="hljs-keyword">if</span> (REST_TEMPLATE.equals(queryType)) &#123;<br>        product = queryProductByRestTemplate(pId);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (NACOS.equals(queryType)) &#123;<br>        product = queryProductByDiscoveryClient(pId);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (RIBBON.equals(queryType)) &#123;<br>        product = queryProductLoadBalancingByRibbon(pId);<br>    &#125;<br><br>    log.info(<span class="hljs-string">&quot;&gt;&gt;商品信息,查询结果:&quot;</span> + JSON.toJSONString(product));<br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>    order.setUId(<span class="hljs-number">1</span>);<br>    order.setUserName(<span class="hljs-string">&quot;测试用户&quot;</span>);<br>    order.setPId(product.getPId());<br>    order.setPName(product.getPName());<br>    order.setPPrice(product.getPPrice());<br>    order.setNumber(<span class="hljs-number">1</span>);<br>    orderService.saveOrder(order);<br>    <span class="hljs-keyword">return</span> order;<br>&#125;<br></code></pre></td></tr></table></figure><p>Ribbon支持的负载均衡策略：<br>Ribbon内置了多种负载均衡策略,内部负载均衡的顶级接口为<code>com.netflix.loadbalancer.IRule</code> , 具体的负载策略如下图所示:</p><table><thead><tr><th>策略名</th><th>策略描述</th><th>实现说明</th></tr></thead><tbody><tr><td>BestAvailableRule</td><td>选择一个最小的并发请求的server</td><td>逐个考察Server，如果Server被 tripped了，则忽略，在选择其中 ActiveRequestsCount最小的server</td></tr><tr><td>AvailabilityFilteringRule</td><td>过滤掉那些因为一直 连接失败的被标记为 circuit tripped的后 端server，并过滤掉 那些高并发的的后端 server（active connections 超过配 置的阈值）</td><td>使用一个AvailabilityPredicate来包含 过滤server的逻辑，其实就就是检查 status里记录的各个server的运行状 态</td></tr><tr><td>WeightedResponseTimeRule</td><td>根据相应时间分配一 个weight，相应时 间越长，weight越 小，被选中的可能性 越低。</td><td>一个后台线程定期的从status里面读 取评价响应时间，为每个server计算 一个weight。Weight的计算也比较简 单responsetime 减去每个server自己 平均的responsetime是server的权 重。当刚开始运行，没有形成statas 时，使用roubine策略选择server。</td></tr><tr><td>RetryRule</td><td>对选定的负载均衡策略机上重试机制。</td><td>在一个配置时间段内当选择server不成功，则一直尝试使用subRule的方式选择一个可用的server</td></tr><tr><td>RoundRobinRule</td><td>轮询方式轮询选server</td><td>轮询index，选择index对应位置的server</td></tr><tr><td>RandomRule</td><td>随机选择一个server</td><td>在index上随机，选择index对应位置的server</td></tr><tr><td>ZoneAvoidanceRule</td><td>复合判断server所在区域的性能和server的可用性选择server</td><td>使用ZoneAvoidancePredicate和AvailabilityPredicate来判断是否选择某个server，前一个判断判定一个zone的运行性能是否可用，剔除不可用的zone（的所有server），AvailabilityPredicate用于过滤掉连接数过多的Server。</td></tr></tbody></table><p>我们可以通过修改配置来调整Ribbon的负载均衡策略，具体代码如下:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">shop-product:</span> <span class="hljs-comment"># 调用的提供者的名称</span><br>  <span class="hljs-attr">ribbon:</span><br>    <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span><br></code></pre></td></tr></table></figure><h2 id="基于Feign实现服务调用"><a href="#基于Feign实现服务调用" class="headerlink" title="基于Feign实现服务调用"></a>基于Feign实现服务调用</h2><h3 id="什么是Feign"><a href="#什么是Feign" class="headerlink" title="什么是Feign"></a>什么是Feign</h3><p>Feign是Spring Cloud提供的一个声明式的伪Http客户端， 它使得调用远程服务就像调用本地服务一样简单， 只需要创建一个接口并添加一个注解即可。<br>Nacos很好的兼容了Feign， Feign默认集成了 Ribbon， 所以在Nacos下使用Fegin默认就实现了负载均衡的效果。</p><h3 id="Feign的使用"><a href="#Feign的使用" class="headerlink" title="Feign的使用"></a>Feign的使用</h3><h4 id="创建新的模块shop-product-api"><a href="#创建新的模块shop-product-api" class="headerlink" title="创建新的模块shop-product-api"></a>创建新的模块<code>shop-product-api</code></h4><blockquote><p>在这里博猪说一下博猪单独创建这个模块的意义或者好处在哪里。博猪也在项目初始化的时候说明了博猪特别不喜欢甚至讨厌所有的Java对象放在common模块里面，但是刚开始用着挺爽的，但是后期项目规模增大后，对象直接的影响或者说带给我们的干扰也挺多的，所以我习惯把feign相关对外提供的接口单独定义，并且字段相关尽量简化，因为feign底层也是http请求，所以尽可能减少http之间的请求时长。</p></blockquote><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--fegin组件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="创建feign接口返回对象"><a href="#创建feign接口返回对象" class="headerlink" title="创建feign接口返回对象"></a>创建feign接口返回对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductVO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:33</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>   <span class="hljs-comment">/** 主键 */</span><br>   <span class="hljs-keyword">private</span> Integer pId;<br>   <span class="hljs-comment">/** 商品名称 */</span><br>   <span class="hljs-keyword">private</span> String pName;<br>   <span class="hljs-comment">/** 商品价格 */</span><br>   <span class="hljs-keyword">private</span> Double pPrice;<br>   <span class="hljs-comment">/** 库存 */</span><br>   <span class="hljs-keyword">private</span> Integer stock;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建Feign接口"><a href="#创建Feign接口" class="headerlink" title="创建Feign接口"></a>创建Feign接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductFeignClient</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(name = &quot;shop-product&quot;,fallback = ProductFeignClientFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_FALLBACK_MSG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;服务不可用！&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据产品id查询产品详情</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> productId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/api/queryProductInfoByProductId/&#123;productId&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ProductVO <span class="hljs-title function_">queryProductInfoByProductId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer productId)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="创建FeignFallback"><a href="#创建FeignFallback" class="headerlink" title="创建FeignFallback"></a>创建FeignFallback</h4><blockquote><p>接口调用异常，会默认跳转到此方法中，在这个方法中可做业务相关处理，比如增加日志等，方便开发和运维排查处理问题。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductFeignClientFallback</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> TODO</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFeignClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ProductVO <span class="hljs-title function_">queryProductInfoByProductId</span><span class="hljs-params">(Integer productId)</span> &#123;<br>        System.out.println(DEFAULT_FALLBACK_MSG);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="修改shop-product模块"><a href="#修改shop-product模块" class="headerlink" title="修改shop-product模块"></a>修改<code>shop-product</code>模块</h4><h5 id="增加依赖"><a href="#增加依赖" class="headerlink" title="增加依赖"></a>增加依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.letcoding<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shop-product-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="开启Feign，在shop-order启动类中增加一下注释："><a href="#开启Feign，在shop-order启动类中增加一下注释：" class="headerlink" title="开启Feign，在shop-order启动类中增加一下注释："></a>开启Feign，在<code>shop-order</code>启动类中增加一下注释：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients</span><br></code></pre></td></tr></table></figure><h5 id="创建Feign接口实现"><a href="#创建Feign接口实现" class="headerlink" title="创建Feign接口实现"></a>创建Feign接口实现</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@ClassName</span> ProductFeignClientImpl</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> 产品feign接口的实现</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span> will</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span> 2021/7/11 18:41</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFeignClientImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProductFeignClient</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ProductService productService;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ProductVO <span class="hljs-title function_">queryProductInfoByProductId</span><span class="hljs-params">(Integer productId)</span> &#123;<br>        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productService.queryById(productId);<br>        log.info(<span class="hljs-string">&quot;查询到商品:&quot;</span> + JSON.toJSONString(product));<br>        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">ProductVO</span> <span class="hljs-variable">productVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductVO</span>();<br>            BeanUtils.copyProperties(product, productVO);<br>            <span class="hljs-keyword">return</span> productVO;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="修改shop-order模块"><a href="#修改shop-order模块" class="headerlink" title="修改shop-order模块"></a>修改<code>shop-order</code>模块</h4><h5 id="去掉shop-product依赖，增加shop-product-api、Feign依赖"><a href="#去掉shop-product依赖，增加shop-product-api、Feign依赖" class="headerlink" title="去掉shop-product依赖，增加shop-product-api、Feign依赖"></a>去掉<code>shop-product</code>依赖，增加<code>shop-product-api</code>、Feign依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.letcoding<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shop-product-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br> <span class="hljs-comment">&lt;!--fegin组件--&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>      <br></code></pre></td></tr></table></figure><h5 id="修改shop-order启动引导类，增加feign扫描"><a href="#修改shop-order启动引导类，增加feign扫描" class="headerlink" title="修改shop-order启动引导类，增加feign扫描"></a>修改<code>shop-order</code>启动引导类，增加feign扫描</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.letcoding.product&quot;)</span><br></code></pre></td></tr></table></figure><h5 id="修改OrderController"><a href="#修改OrderController" class="headerlink" title="修改OrderController"></a>修改<code>OrderController</code></h5><ul><li>添加产品feign接口</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ProductFeignClient productFeignClient;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FEIGN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;feign&quot;</span>;<br></code></pre></td></tr></table></figure><ul><li>增加feign接口相关实现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * RestTemplate   负载均衡风格查询</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> pId    产品id</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> Product <span class="hljs-title function_">queryProductLoadBalancingByFeign</span><span class="hljs-params">(Integer pId)</span> &#123;<br>      <span class="hljs-type">ProductVO</span> <span class="hljs-variable">productVO</span> <span class="hljs-operator">=</span> productFeignClient.queryProductInfoByProductId(pId);<br>      <span class="hljs-keyword">if</span> (productVO != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();<br>          BeanUtils.copyProperties(productVO, product);<br>          <span class="hljs-keyword">return</span> product;<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><ul><li>修改订单保存方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 保存指定产品订单</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pId</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/save/&#123;pId&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">order</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;pId&quot;)</span> Integer pId, <span class="hljs-meta">@RequestParam(name = &quot;queryType&quot;)</span> String queryType)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;&gt;&gt;客户下单，这时候要调用商品微服务查询商品信息&quot;</span>);<br>    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// 通过restTemplate调用商品微服务</span><br>    <span class="hljs-keyword">if</span> (FEIGN.equals(queryType)) &#123;<br>        product = queryProductLoadBalancingByFeign(pId);<br>    &#125;<br><br>    log.info(<span class="hljs-string">&quot;&gt;&gt;商品信息,查询结果:&quot;</span> + JSON.toJSONString(product));<br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>    order.setUId(<span class="hljs-number">1</span>);<br>    order.setUserName(<span class="hljs-string">&quot;测试用户&quot;</span>);<br>    order.setPId(product.getPId());<br>    order.setPName(product.getPName());<br>    order.setPPrice(product.getPPrice());<br>    order.setNumber(<span class="hljs-number">1</span>);<br>    orderService.saveOrder(order);<br>    <span class="hljs-keyword">return</span> order;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="重启order微服务-查看效果"><a href="#重启order微服务-查看效果" class="headerlink" title="重启order微服务,查看效果"></a>重启order微服务,查看效果</h4></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/" class="category-chain-item">好好码代码吖</a> <span>></span> <a href="/categories/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/" class="category-chain-item">JAVA</a> <span>></span> <a href="/categories/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/" class="category-chain-item">Spring</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/JAVA/">#JAVA</a> <a href="/tags/Spring/">#Spring</a> <a href="/tags/SpringCloud/">#SpringCloud</a> <a href="/tags/SpringCloud-Alibaba/">#SpringCloud Alibaba</a></div></div><div class="license-box my-3"><div class="license-title"><div>Spring-Cloud-Alibaba(3)-服务治理</div><div>https://github.com/yangxiangnanwill/yangxiangnanwill.github.io/2024/01/03/好好码代码吖/JAVA/Spring/Spring-Cloud-Alibaba(3)-服务治理/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>will</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2024年1月3日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/01/03/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/Spring-Cloud-Alibaba(5)-%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3/" title="Spring-Cloud-Alibaba(5)-服务网关"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Spring-Cloud-Alibaba(5)-服务网关</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/01/03/%E5%A5%BD%E5%A5%BD%E7%A0%81%E4%BB%A3%E7%A0%81%E5%90%96/JAVA/Spring/Spring-Cloud-Alibaba(2)-%E6%90%AD%E5%BB%BA%E9%A1%B9%E7%9B%AE/" title="Spring-Cloud-Alibaba(2)-搭建项目"><span class="hidden-mobile">Spring-Cloud-Alibaba(2)-搭建项目</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",function(){NProgress.done()})</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js"></script><script>!function(t){var e=Fluid.plugins.typing;(t=t.getElementById("subtitle"))&&e&&e(t.getAttribute("data-typed-text"))}((window,document))</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",function(){var t,o=jQuery("#toc");0!==o.length&&window.tocbot&&(t=jQuery("#board-ctn").offset().top,window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-t},CONFIG.toc)),0<o.find(".toc-list-item").length&&o.css("visibility","visible"),Fluid.events.registerRefreshCallback(function(){var t;"tocbot"in window&&(tocbot.refresh(),0!==(t=jQuery("#toc")).length)&&tocbot&&0<t.find(".toc-list-item").length&&t.css("visibility","visible")}))})</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback(function(){if("anchors"in window){anchors.removeAll();var n,o=[];for(n of(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","))o.push(".markdown-body > "+n.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}})})</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",function(){Fluid.plugins.fancyBox()})</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>